#!/bin/sh

set -e

CACHEDIR=$HOME/.cache/llpp

die() {
    echo "$1" >&2
    exit 1
}

executable_p() {
    command -v "$1" >/dev/null 2>&1
}

trap 'test -n "$casp" && rm -f "$casp"' 0

test -d "$CACHEDIR" || die "cache directory '$CACHEDIR' does not exist"
while getopts m:t:f opt; do
    case $opt in
        m) mime=$OPTARG;;
        t) type=$OPTARG;;
        f) force=1;;
        ?) die "usage: $0 [-m mime/type] [-t filter] [-f] path";;
    esac
done
shift $(($OPTIND - 1))
test -z "$1" && die "usage $0: path"

ft=$(file -L --mime-type -b "$1") || die "$ft"

case $ft in
    application/x-gzip | application/x-compress) dc=zcat;;
    application/x-xz) dc=xzcat;;
    application/x-bzip2) dc=bzcat;;
    *) unset dc || true;;
esac

filt='"${dc-cat}" "$1" |'

if test -z "$type"; then
    test -z "$dc" || ft=$(file -L --mime-type -bz "$1") || die "$ft"

    mime=${mime:-$ft}
    case $mime in
        application/postscript) type=ps;;
        application/pdf) type=pdf;;
        image/vnd.djvu) type=djvu;;
        text/html) type=html;;
        application/msword) type=word;;
        application/vnd.openxmlformats-officedocument.*  \
            | application/vnd.ms-powerpoint              \
            | application/vnd.ms-excel                   \
            | application/vnd.oasis.opendocument.*) type=uno;;
        image/svg+xml) type=svg;;
        image/png | image/jpeg) test -n "$dc" && type="image" || type="image2";;
        image/*) type=image;;
        application/x-dvi) type=dvi;;
        *) die "unhandled file type: '$mime'";;
    esac
fi

suff=
opts=

case $type in
    ps) conv='ps2pdf - "$casp"';;
    pdf) test -z "$dc" && exec llpp "$@" || conv='cat >"$casp"';;
    djvu) conv='djvups - | ps2pdf - "$casp"';;
    html) {
        test -n "$dc" && die "can not convert compressed '$mime'"
        unset filt
        conv='prince "$1" -o "$casp"'
    };;
    word) {
        if executable_p unoconv && test -z "$dc"; then
            unset filt
            conv='unoconv -o "$casp" "$1"'
        else
            conv='antiword -m 8859-1.txt -a a4 - >"$casp"'
        fi
    };;
    uno) {
        test -n "$dc" && die "can not convert compressed '$mime'"
        unset filt
        conv='unoconv -o "$casp" "$1"'
    };;
    svg) {
        executable_p rsvg-convert                        \
            && conv='rsvg-convert -f pdf -o "$casp"'     \
            || conv='inkscape -z -A "$casp" -'
    };;
    image) conv='convert - pdf:"$casp"';;
    image2) {
        suff=".cbz"
        opts="-cxack"
        conv='zip -0q "$casp" "$1"'
    };;
    dvi) {
        test -n "$dc" && die "can not convert compressed '$mime'"
        unset filt
        conv='dvipdf "$1" "$casp"'
    };;
    *) die "unhandled filter type: '$type'";;
esac

hash=$(md5sum "$1") || die "$hash"
casp=$CACHEDIR/${hash%% *}$suff
(test -n "$force" -o ! -e "$casp") && eval "$filt" "$conv"

exec llpp $opts -origin "$@" "$casp"
