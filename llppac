#!/bin/sh

set -e

CACHEDIR=$HOME/.config/llpp

die()
{
    fmt=$1
    shift
    printf "$fmt\n" "$*" >&2
    exit 1
}

executable_p() {
    command -v $1 >/dev/null 2>&1
}

trap '! test -z $casp && rm -f $casp' 0

test -d $CACHEDIR || die "cache directory %s does not exist" $CACHEDIR
test -z "$1" && die "usage %s: path" $0

ft=$(file --mime-type -b "$1")

case $ft in
    application/x-gzip) dc=zcat;;
    application/x-xz) dc=xzcat;;
    application/x-bzip2) dc=bzcat;;
    *) unset dc;;
esac

test -z $dc || ft=$(file --mime-type -bz "$1")

case $ft in
    application/postscript) conv='ps2pdf - $casp';;
    application/pdf) test -z $dc && exec llpp "$1" || conv='cat >$casp';;
    image/vnd.djvu) conv='djvups - | ps2pdf - $casp';;
    application/msword) {
        if executable_p unoconv && test -z $dc; then
            dc=true # shrug
            conv='unoconv -o $casp $1'
        else
            conv='antiword -m 8859-1.txt -a a4 - >$casp'
        fi
    };;
    application/vnd.openxmlformats-officedocument.*) {
        if executable_p unoconv; then
            ! test -z $dc && die "can not convert compressed openxml"
            dc=true
            conv='unoconv -o $casp $1'
        else
            die 'unoconv not found'
        fi
    };;
    image/svg+xml) {
        executable_p rsvg-convert \
            && conv='rsvg-convert -f pdf -o $casp' \
            || conv='inkscape -z -A $casp -'
    };;
    application/x-dvi) {
        test -z $dc || die "can not handle compressed DVIs"
        conv='dvipdf - $casp'
    };;
    *) die "unhandled file type: %s" $ft;;
esac

hash=$(md5sum "$1" | cut -f 1 -d\ )
casp="$CACHEDIR/$hash"
test -e $casp || eval "${dc-cat} \"$1\" | $conv"

exec llpp -origin "$1" $casp
