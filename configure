#!/bin/sh
set -e

unset cflags
usage () {
    printf "usage: $0 [-e] [path-to-git-checkout-of-mupdf] " \
           "[build-type[=native]]"
    printf "\noptions:\n"
    printf -- " -e: use EGL\n"
    exit $1
}

while getopts e opt; do
    case $opt in
        e) egl="egl"; cflags="-DUSE_EGL";;
        ?) usage 0
    esac
done
shift $(($OPTIND - 1))

mupdf="$1"
test -e "$mupdf" || {
    printf "Don't know where to find mupdf's git checkout\n"
    usage 1
}
pkgs="freetype2 fontconfig zlib x11 openssl libopenjp2" # j(peg|big2dec)?
test -z "$egl" || pkgs="$pkgs egl"
pwd=$(pwd -P)

expr "$0" : "/.*" >/dev/null && {
    path="$0"
    builddir="$pwd"
    helpcmdl=" -f $(dirname $path)/build.ninja"
} || {
    path="$pwd/$0"
    builddir="build"
    helcmdl=""
}
absbuilddir=$(cd $builddir && pwd -P)

(printf "cflags=$cflags $(pkg-config --cflags $pkgs)\n"
 printf "lflags=$(pkg-config --libs $pkgs) -ljbig2dec -ljpeg -lz\n"
 printf "srcdir=$(dirname $path)\n"
 printf "buildtype=${2:-native}\n"
 printf "mupdf=$mupdf\n"
 printf "builddir=$builddir\n"
 printf "absbuilddir=$absbuilddir\n"
 test $(uname -m) = "x86_64" && {
     printf "cflags=\$cflags -fPIC\n"
     printf "mujs=-lmujs\n"
 }) >.config

echo "To build - type: ninja$helpcmdl"
