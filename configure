#!/bin/sh -e

test -z "$1" && mupdf=/home/malc/x/rcs/git/mupdf
test -e "$mupdf" || {
    printf "Pleas supply patch to mupdf\n" >&2
    printf "$0 [path-to-git-clone-of-mupdf] [build-type[=native]]\n" >&2
    exit 1
}
pkgs="freetype2 fontconfig zlib x11 openssl libopenjp2" # j(peg|big2dec)?

expr "$0" : "/.*" >/dev/null && {
    path="$0"
    builddir="$PWD"
} || {
    path="$PWD/$0"
    builddir="$PWD/build"
}

(
    exec >.config
    printf "cflags=$(pkg-config --cflags $pkgs)\n"
    printf "lflags=$(pkg-config --libs $pkgs) -ljbig2dec -ljpeg -lz\n"
    printf "srcdir=$(dirname $path)\n"
    printf "buildtype=${2:-native}\n"
    printf "mupdf=$mupdf\n"
    printf "builddir=$builddir\n"
    test $(uname -m) = "x86_64" && {
        printf "cflags=\$cflags -fPIC\n"
        printf "mujs=-lmujs\n"
    }
)

echo "To build type: ninja -f $(dirname $path)/build.ninja"
