#!/bin/sh
set -e

unset cflags
buildtype=native

usage () {
    echo "$1"
    cat 1>&2 <<EOF
usage: $0 [-e] [-b build-type] [mudir]
options:
 -e: use EGL
 -b: MuPDF's build type [default native]

 build-type = debug|release|native
 mudir      = path to MuPDF's git checkout
EOF
    exit $2
}

while getopts eb: opt; do
    case $opt in
        e) egl="egl"; cflags="-DUSE_EGL";;
        b) buildtype="$OPTARG";;
        ?) usage "" 0;;
    esac
done
shift $(($OPTIND - 1))

mupdf="$1"
test -e "$mupdf" || {
    usage "Don't know where to find MuPDF's git checkout" 1
}
pkgs="freetype2 fontconfig zlib x11 openssl libopenjp2" # j(peg|big2dec)?
test -z "$egl" || pkgs="$pkgs egl"
pwd=$(pwd -P)

expr "$0" : "/.*" >/dev/null && {
    path="$0"
    builddir="$pwd"
    helpcmdl=" -f $(dirname $path)/build.ninja"
} || {
    path="$pwd/$0"
    builddir="build"
    helcmdl=""
}
absbuilddir=$(cd >/dev/null $builddir && pwd -P)

(echo "cflags=$cflags $(pkg-config --cflags $pkgs)"
 echo "lflags=$(pkg-config --libs $pkgs) -ljbig2dec -ljpeg -lz"
 echo "srcdir=$(cd >/dev/null $(dirname $0) && pwd -P)"
 echo "buildtype=$buildtype"
 echo "mupdf=$mupdf"
 echo "builddir=$builddir"
 echo "absbuilddir=$absbuilddir"
 test $(uname -m) = "x86_64" && {
     echo "cflags=\$cflags -fPIC"
     echo "mujs=-lmujs"
 }) >.config || true

echo "To build - type: ninja$helpcmdl"
