#!/bin/sh
set -e

test -z "$1" && mupdf=$HOME/x/rcs/git/mupdf
test -e "$mupdf" || {
    printf >&2 "Pleas supply path to mupdf\n"
    printf >&2 "$0 [path-to-git-clone-of-mupdf] [build-type[=native]]\n"
    exit 1
}
pkgs="freetype2 fontconfig zlib x11 openssl libopenjp2" # j(peg|big2dec)?
pwd=$(pwd -P)

expr "$0" : "/.*" >/dev/null && {
    path="$0"
    builddir="$pwd"
    helpcmdl=" -f $(dirname $path)/build.ninja"
} || {
    path="$pwd/$0"
    builddir="build"
    helcmdl=""
}
absbuilddir=$(cd $builddir && pwd -P)

(printf "cflags=$(pkg-config --cflags $pkgs)\n"
 printf "lflags=$(pkg-config --libs $pkgs) -ljbig2dec -ljpeg -lz\n"
 printf "srcdir=$(dirname $path)\n"
 printf "buildtype=${2:-native}\n"
 printf "mupdf=$mupdf\n"
 printf "builddir=$builddir\n"
 printf "absbuilddir=$absbuilddir\n"
 test $(uname -m) = "x86_64" && {
     printf "cflags=\$cflags -fPIC\n"
     printf "mujs=-lmujs\n"
 }) >.config

echo "To build - type: ninja$helpcmdl"
